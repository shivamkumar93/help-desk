{% extends 'user/userbase.html' %}
{% load crispy_forms_tags %}
{% block title %}Ticket #{{ ticket.id }} - {{ ticket.title }}{% endblock %}

{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6  ">

    <!-- Back Button -->
    <a href="{% url 'userdashboard' %}"
        class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium mb-4 transition text-sm">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to My Tickets
    </a>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

        <!-- Main Content -->
        <div class="lg:col-span-3 space-y-8">

            <!-- Ticket Header -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="bg-gray-50/80 border-b border-gray-200 px-6 py-5">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">
                                #{{ ticket.id }} â€“ {{ ticket.title }}
                            </h1>
                            <p class="text-sm text-gray-500 mt-1">
                                Created on {{ ticket.created_at|date:"d M Y \a\t H:i" }}
                            </p>
                            <h3>Attachments:</h3>
                            {% if attachments %}
                            <ul>
                                {% for attachment in attachments %}
                                <li>
                                    <a href="{{ attachment.file.url }}" target="_blank" class="text-md text-gray-600 hover:underline">
                                        {{ attachment.file.name }} 
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p>No attachments uploaded.</p>
                            {% endif %}
                        </div>

                        <!-- Soft Status Badge -->
                        {% if ticket.status == 'open' %}
                        <span
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium bg-emerald-50 text-emerald-700 border border-emerald-200">
                            Open
                        </span>
                        {% elif ticket.status == 'closed' %}
                        <span
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-600 border border-gray-300">
                            Closed
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium bg-amber-50 text-amber-700 border border-amber-200">
                            In Progress
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="p-3">
                    <h3 class="text-lg font-semibold text-gray-800 mb-1">Description</h3>
                    <div class="bg-gray-50 rounded-lg px-5 text-gray-700 whitespace-pre-wrap text-sm leading-relaxed">
                        {{ ticket.description|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Conversation -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 ">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900">Conversation</h2>
                </div>

                <div class="p-6 space-y-3 overflow-y-scroll ">

                    {% for reply in replies %}

                    {% if reply.author.role == 'superadmin' or reply.author.is_superuser %}
                    <!-- Super Admin Reply -->
                    <div class="flex justify-end">
                        <div class="max-w-xl w-full">
                            <div
                                class="bg-indigo-50 border border-indigo-200 text-gray-800 rounded-2xl rounded-tr-none px-5 py-4">
                                <div class="flex items-center gap-3 mb-3">
                                    <!-- <div class="w-9 h-9 bg-indigo-200 rounded-full flex items-center justify-center text-indigo-700 font-bold text-sm">
                                            A
                                        </div> -->
                                    <div>
                                        <p class="font-semibold text-indigo-900">Super Admin</p>
                                        <p class="text-xs text-gray-600">{{reply.author.username }}</p>
                                    </div>
                                </div>
                                <p class="whitespace-pre-wrap text-sm leading-relaxed">{{ reply.comment|linebreaksbr }}
                                </p>
                                <p class="text-xs text-gray-500 mt-3 text-right">
                                    {{ reply.created_at|date:"d M Y \a\t H:i" }}
                                </p>
                            </div>
                        </div>
                    </div>

                    {% elif reply.author.role == 'staff' %}
                    <!-- Staff Reply -->
                    <div class="flex justify-end">
                        <div class="max-w-xl justify-start">
                            <div
                                class="bg-sky-50 border border-sky-200 text-gray-800 rounded-2xl rounded-tr-none px-5 py-2">
                                <div class="flex items-center gap-1 ">
                                    <!-- <div class="w-9 h-9 bg-sky-200 rounded-full flex items-center justify-center text-sky-700 font-bold text-sm">
                                            S
                                        </div> -->
                                    <div>
                                        <p class="font-semibold text-sky-900">Support Team ( <span
                                                class="text-xs text-gray-600">{{reply.author.username }}</span> )
                                        </p>
                                        <p></p>
                                    </div>
                                </div>
                                <p class="whitespace-pre-wrap text-sm leading-relaxed justify-end">{{reply.comment|linebreaksbr }}</p>
                                <p class="text-xs text-gray-500 mt-2 text-right">
                                    {{ reply.created_at|date:"d M Y \a\t H:i" }}
                                </p>
                            </div>
                        </div>
                    </div>

                    {% else %}
                    <!-- Customer Reply -->
                    <div class="flex justify-start">
                        <div class="max-w-xl ">
                            <div
                                class="bg-gray-100 border border-gray-300 text-gray-800 rounded-2xl rounded-tl-none px-5 py-2">
                                <div class="flex items-center ">
                                    <!-- <div class="w-9 h-9 bg-gray-300 rounded-full flex items-center justify-center font-bold text-gray-700 text-sm">
                                            {{ reply.author.username|slice:":1"|upper }}
                                        </div> -->
                                    <div>
                                        <p class="font-semibold">You </p>

                                    </div>
                                </div>
                                <p class="whitespace-pre-wrap text-sm leading-relaxed">{{ reply.comment|linebreaksbr }}
                                </p>
                                <p class="text-xs text-gray-500 mt-3 text-right">
                                    {{ reply.created_at|date:"d M Y \a\t H:i" }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% empty %}
                    <div class="text-center py-16 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p>No replies yet. Start the conversation!</p>
                    </div>
                    {% endfor %}

                </div>
            </div>
        </div>

        <!-- Reply Form Sidebar -->
        {% if ticket.status != 'closed' %}
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 sticky top-24">
                <h3 class="text-xl font-bold text-gray-900 ">Add Your Reply</h3>

                <form method="POST" class="space-y-2">
                    {% csrf_token %}
                    {{ form|crispy }}

                    <button type="submit"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 rounded-lg transition shadow-sm hover:shadow-md flex items-center justify-center gap-2">

                        Send Reply
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="lg:col-span-1">
            <div class="bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 p-10 text-center">
                <div class="w-20 h-20 bg-gray-200 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.94 4h13.88a1.88 1.88 0 001.88-1.88V8.12a1.88 1.88 0 00-1.88-1.88H5.94a1.88 1.88 0 00-1.88 1.88v8.88a1.88 1.88 0 001.88 1.88z" />
                    </svg>
                </div>
                <p class="text-lg font-medium text-gray-700">Ticket Closed</p>
                <p class="text-sm text-gray-500 mt-1">No further replies allowed.</p>
            </div>
        </div>
        {% endif %}

    </div>
</div>

{% endblock content %}